name: AI Fix with Claude Code

on:
  issues:
    types: [labeled, opened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number
      issue_title:
        description: 'Issue title (optional, for display)'
        required: false
        type: string
      model:
        description: 'Claude model to use'
        required: false
        type: choice
        default: 'sonnet'
        options:
          - sonnet
          - opus

run-name: "${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/ai-retry') && format('AI Retry PR #{0}', github.event.issue.number) || format('AI Fix #{0}: {1}', github.event.inputs.issue_number || github.event.issue.number, github.event.inputs.issue_title || github.event.issue.title || 'Processing...') }}"

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  # Use workflow_dispatch input if available, otherwise use issue event number
  ISSUE_NUM: ${{ github.event.inputs.issue_number || github.event.issue.number }}

jobs:
  # Job for new issues - creates initial PR
  ai-fix:
    if: |
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'triage/accepted' && contains(github.event.issue.labels.*.name, 'ai-fix-requested')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Set issue number
        id: issue
        run: |
          ISSUE_NUM="${{ github.event.inputs.issue_number || github.event.issue.number }}"
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Get issue details
        id: issue_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }})
          echo "title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_JSON" | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add rocket reaction to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/reactions \
            -X POST \
            -f content='rocket'

      - name: Comment on issue start
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --body "üöÄ Claude Code is analyzing this issue and working on a fix. I'll update you when I have results!

          View progress: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install dependencies
        run: |
          cd web && npm ci
          go mod download

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "$(npm bin -g)" >> $GITHUB_PATH

      - name: Setup fix branch
        id: branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@kubestellar.io"
          BRANCH="ai-fix/issue-${{ steps.issue.outputs.number }}"

          # Check if branch exists remotely
          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            echo "Branch exists, fetching and checking out..."
            git fetch origin "$BRANCH"
            git checkout -b "$BRANCH" "origin/$BRANCH"
            echo "branch_existed=true" >> $GITHUB_OUTPUT
          else
            echo "Creating new branch..."
            git checkout -b "$BRANCH"
            echo "branch_existed=false" >> $GITHUB_OUTPUT
          fi

          # Check if PR already exists
          PR_NUM=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
          echo "existing_pr=$PR_NUM" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue_details.outputs.title }}
          ISSUE_BODY: ${{ steps.issue_details.outputs.body }}
        run: |
          # Create prompt directly without heredoc
          PROMPT="You are fixing a bug or implementing a feature request for the KubeStellar Console project.

          Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          Description:
          ${ISSUE_BODY}

          Instructions:
          1. Analyze the codebase to understand the issue
          2. Implement a fix or feature as described
          3. Make minimal, focused changes
          4. Ensure the code compiles and follows project patterns
          5. Add any necessary tests
          6. Do not create markdown documentation files
          7. Do not modify any files in .github/workflows/

          The project structure:
          - /web: React 18 + TypeScript + Vite frontend
          - /pkg: Go backend with Fiber framework
          - /pkg/api: API handlers
          - /pkg/store: SQLite data store
          - /pkg/models: Data models

          Please implement the fix now."

          # Run Claude Code in non-interactive mode with permission to edit files
          # Use --dangerously-skip-permissions to auto-approve file edits in CI
          # --max-turns 30 limits cost to ~$0.50-0.75 for sonnet, ~$3-4 for opus
          MODEL="${{ github.event.inputs.model || 'sonnet' }}"
          npx -y @anthropic-ai/claude-code --dangerously-skip-permissions --model "$MODEL" --max-turns 30 "$PROMPT" || true

      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # Restore files that shouldn't be committed
          git checkout -- web/dist/ 2>/dev/null || true
          git checkout -- '*.tsbuildinfo' 2>/dev/null || true
          git checkout -- '*.lock' 2>/dev/null || true
          git checkout -- 'package-lock.json' 2>/dev/null || true
          git checkout -- '.github/workflows/' 2>/dev/null || true

          # Check if there are still meaningful changes after excluding build artifacts
          if [ -z "$(git status --porcelain)" ]; then
            echo "No meaningful changes after excluding build artifacts"
            exit 0
          fi

          git add -A
          git commit -s -m "ü§ñ fix: Address issue #${{ steps.issue.outputs.number }}

          AI-generated fix for: ${{ steps.issue_details.outputs.title }}

          Closes #${{ steps.issue.outputs.number }}

          Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
          git push origin "ai-fix/issue-${{ steps.issue.outputs.number }}"

      - name: Create or update Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXISTING_PR: ${{ steps.branch.outputs.existing_pr }}
        run: |
          # If PR already exists, just comment on it
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists, adding comment..."
            gh pr comment "$EXISTING_PR" --body "üîÑ **New iteration pushed!**

            Claude Code has pushed additional changes based on the latest run.

            View the updated diff to see what changed.

            ---
            *Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*"
            exit 0
          fi

          # Extract Console Request ID from issue body if present
          CONSOLE_REQUEST_ID=$(echo "${{ steps.issue_details.outputs.body }}" | grep -oP 'Console Request ID:\*\* \K[0-9a-f-]{36}' || echo "")

          # Ensure ai-generated label exists
          gh label create "ai-generated" --color "7057ff" --description "Pull request generated by AI" 2>/dev/null || true

          # Build PR body with optional Console Request ID
          PR_BODY="## AI-Generated Fix

          This PR was automatically generated by Claude Code to address:
          - Issue: #${{ steps.issue.outputs.number }}
          - Title: ${{ steps.issue_details.outputs.title }}"

          if [ -n "$CONSOLE_REQUEST_ID" ]; then
            PR_BODY="$PR_BODY
          - **Console Request ID:** $CONSOLE_REQUEST_ID"
          fi

          PR_BODY="$PR_BODY

          ### What Changed
          See the commit diff for details on the changes made.

          ### Testing
          - [ ] Verify the fix works as expected
          - [ ] Check the Netlify preview deployment
          - [ ] Review code changes

          ### Feedback
          If the fix isn't quite right, maintainers can comment \`/ai-retry <feedback>\` to have Claude Code try again with additional context.

          ---
          *Generated by Claude Code*"

          gh pr create \
            --title "ü§ñ fix: ${{ steps.issue_details.outputs.title }}" \
            --body "$PR_BODY" \
            --label "ai-generated"

      - name: Comment on issue - success
        if: steps.check_changes.outputs.has_changes == 'true' && steps.branch.outputs.existing_pr == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --body "A fix has been generated and a pull request has been created. You will be notified when a preview deployment is ready for testing.

          Check the linked PR for details on the changes."

      - name: Comment on issue - updated
        if: steps.check_changes.outputs.has_changes == 'true' && steps.branch.outputs.existing_pr != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --body "The existing PR has been updated with new changes. Check PR #${{ steps.branch.outputs.existing_pr }} for the latest iteration."

      - name: Comment on issue - no changes
        if: steps.check_changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --body "Claude Code analyzed this issue but couldn't determine the necessary changes automatically. A human developer will review this issue.

          This could happen because:
          - The issue description needs more detail
          - The fix requires complex architectural changes
          - The issue may already be resolved

          We'll update you when there's progress."

      - name: Remove label on completion
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.issue.outputs.number }} --remove-label "ai-fix-requested"
          gh issue edit ${{ steps.issue.outputs.number }} --add-label "ai-processing-complete"

  # Job for PR feedback - retries with maintainer guidance
  ai-retry:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/ai-retry')
    runs-on: ubuntu-latest

    steps:
      - name: Add eyes reaction to comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -X POST \
            -f content='eyes'

      - name: Extract PR and feedback info
        id: info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.issue.number }}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Extract feedback (everything after /ai-retry)
          FEEDBACK=$(echo "${{ github.event.comment.body }}" | sed 's|^/ai-retry[[:space:]]*||')
          echo "feedback<<EOF" >> $GITHUB_OUTPUT
          echo "$FEEDBACK" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get PR details
          PR_JSON=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          echo "pr_title=$(echo "$PR_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "pr_branch=$(echo "$PR_JSON" | jq -r '.head.ref')" >> $GITHUB_OUTPUT
          echo "pr_body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_JSON" | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract linked issue number from PR body
          ISSUE_NUM=$(echo "$PR_JSON" | jq -r '.body' | grep -oP 'Issue: #\K[0-9]+' | head -1 || echo "")
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Get original issue details
        id: issue_details
        if: steps.info.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh api repos/${{ github.repository }}/issues/${{ steps.info.outputs.issue_number }})
          echo "title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_JSON" | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          gh pr diff ${{ steps.info.outputs.pr_number }} --repo ${{ github.repository }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get PR review comments
        id: reviews
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "comments<<EOF" >> $GITHUB_OUTPUT
          gh api repos/${{ github.repository }}/pulls/${{ steps.info.outputs.pr_number }}/comments \
            --jq '.[] | "File: \(.path)\nLine: \(.line // .original_line)\nComment: \(.body)\n---"' >> $GITHUB_OUTPUT || true
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR - starting retry
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.info.outputs.pr_number }} --repo ${{ github.repository }} --body "üîÑ Claude Code is retrying with your feedback. I'll update this PR when done!

          View progress: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.info.outputs.pr_branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install dependencies
        run: |
          cd web && npm ci
          go mod download

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "$(npm bin -g)" >> $GITHUB_PATH

      - name: Configure git
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@kubestellar.io"

      - name: Run Claude Code with feedback
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ steps.info.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue_details.outputs.title }}
          ISSUE_BODY: ${{ steps.issue_details.outputs.body }}
          PR_NUMBER: ${{ steps.info.outputs.pr_number }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          REVIEW_COMMENTS: ${{ steps.reviews.outputs.comments }}
          MAINTAINER_FEEDBACK: ${{ steps.info.outputs.feedback }}
        run: |
          PROMPT="You are improving an AI-generated fix based on maintainer feedback.

          ## Original Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          ## Current PR Changes (what you previously implemented)

          ${PR_DIFF}

          ## Review Comments on the PR

          ${REVIEW_COMMENTS}

          ## Maintainer Feedback

          ${MAINTAINER_FEEDBACK}

          ## Instructions

          1. Review the maintainer feedback carefully
          2. Understand what needs to be changed or improved
          3. Make the necessary modifications to address the feedback
          4. Ensure the code compiles and follows project patterns
          5. Do not create markdown documentation files
          6. Do not modify any files in .github/workflows/

          The project structure:
          - /web: React 18 + TypeScript + Vite frontend
          - /pkg: Go backend with Fiber framework
          - /pkg/api: API handlers
          - /pkg/store: SQLite data store
          - /pkg/models: Data models

          Please implement the improvements now."

          # Use Sonnet for retries (cost efficient), --max-turns 30 for cost control
          npx -y @anthropic-ai/claude-code --dangerously-skip-permissions --model sonnet --max-turns 30 "$PROMPT" || true

      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # Restore files that shouldn't be committed
          git checkout -- web/dist/ 2>/dev/null || true
          git checkout -- '*.tsbuildinfo' 2>/dev/null || true
          git checkout -- '*.lock' 2>/dev/null || true
          git checkout -- 'package-lock.json' 2>/dev/null || true
          git checkout -- '.github/workflows/' 2>/dev/null || true

          # Check if there are still meaningful changes after excluding build artifacts
          if [ -z "$(git status --porcelain)" ]; then
            echo "No meaningful changes after excluding build artifacts"
            exit 0
          fi

          git add -A
          git commit -s -m "ü§ñ fix: Address feedback on PR #${{ steps.info.outputs.pr_number }}

          Maintainer feedback: ${{ steps.info.outputs.feedback }}

          Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
          git push origin ${{ steps.info.outputs.pr_branch }}

      - name: Add rocket reaction to comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -X POST \
            -f content='rocket'

      - name: Comment on PR - success
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.info.outputs.pr_number }} --repo ${{ github.repository }} --body "‚úÖ Changes have been pushed based on your feedback!

          Please review the updated diff."

      - name: Comment on PR - no changes
        if: steps.check_changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.info.outputs.pr_number }} --repo ${{ github.repository }} --body "‚ö†Ô∏è Claude Code processed the feedback but didn't make any changes.

          This could mean:
          - The feedback requires manual intervention
          - The current implementation already addresses the concern
          - More specific guidance is needed

          Please provide more details or make the changes manually."
