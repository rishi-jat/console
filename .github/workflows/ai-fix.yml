name: AI Fix with Copilot
# Automates AI-assisted issue resolution via GitHub Copilot

on:
  issues:
    types: [labeled]
  pull_request:
    types: [opened, ready_for_review, closed, synchronize]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: string
      issue_title:
        description: 'Issue title (optional, for display)'
        required: false
        type: string

run-name: "AI Fix #${{ github.event.inputs.issue_number || github.event.issue.number }}: ${{ github.event.inputs.issue_title || github.event.issue.title || 'Processing...' }}"

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  trigger-copilot:
    # Trigger when triage/accepted is added AND ai-fix-requested label exists, OR via manual dispatch.
    # Guard: skip if ai-processing is already set (triage-command.yml or copilot-assigned.yml handled it).
    if: |
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'triage/accepted' && contains(github.event.issue.labels.*.name, 'ai-fix-requested') && !contains(github.event.issue.labels.*.name, 'ai-processing') && !contains(github.event.issue.labels.*.name, 'ai-awaiting-fix')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Set issue number
        id: issue
        run: |
          ISSUE_NUM="${{ github.event.inputs.issue_number || github.event.issue.number }}"
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Check if already being processed
        id: check_processing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.issue.outputs.number }}"
          LABELS=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUM \
            --jq '[.labels[].name] | join(",")' 2>/dev/null || echo "")
          ASSIGNEES=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUM \
            --jq '[.assignees[].login] | join(",")' 2>/dev/null || echo "")

          if echo "$LABELS" | grep -q "ai-processing\|ai-awaiting-fix\|ai-pr-draft\|ai-pr-ready"; then
            echo "already_processing=true" >> $GITHUB_OUTPUT
            echo "Issue #$ISSUE_NUM already in pipeline (labels: $LABELS)"
          elif echo "$ASSIGNEES" | grep -qi "copilot"; then
            echo "already_processing=true" >> $GITHUB_OUTPUT
            echo "Issue #$ISSUE_NUM already assigned to Copilot"
          else
            echo "already_processing=false" >> $GITHUB_OUTPUT
          fi

      - name: Get issue details
        if: steps.check_processing.outputs.already_processing != 'true'
        id: issue_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }})
          echo "title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_JSON" | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add rocket reaction to issue
        if: steps.check_processing.outputs.already_processing != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/reactions \
            -X POST \
            -f content='rocket'

      - name: Update labels - processing
        if: steps.check_processing.outputs.already_processing != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create labels if they don't exist
          gh label create "ai-processing" --repo "$REPO" --color "fbca04" --description "AI is currently processing this issue" 2>/dev/null || true
          gh label create "ai-fix-requested" --repo "$REPO" --color "d4c5f9" --description "AI fix has been requested" 2>/dev/null || true

          # Update status: remove requested, add processing
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-fix-requested" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-processing"

      - name: Assign Copilot to issue
        if: steps.check_processing.outputs.already_processing != 'true'
        id: assign_copilot
        uses: otto-de/assign_issue_toCopilot_action@v1.0.1
        with:
          issue_number: ${{ steps.issue.outputs.number }}
          github_token: ${{ secrets.COPILOT_PAT }}

      - name: Post instructions comment
        if: steps.check_processing.outputs.already_processing != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.issue.outputs.number }}"
          ASSIGN_SUCCESS="${{ steps.assign_copilot.outputs.success }}"

          if [ "$ASSIGN_SUCCESS" == "true" ]; then
            HEADER="## ðŸ¤– AI Fix Requested"
          else
            HEADER="## ðŸ¤– AI Fix Requested (fallback: @Copilot mention)"
          fi

          gh issue comment "$ISSUE_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          $HEADER

          @Copilot Please analyze this issue and create a fix.

          ### Instructions:
          1. Read the issue description carefully
          2. Explore the codebase to understand the context
          3. Implement the requested changes
          4. Create a PR with \`Fixes #$ISSUE_NUM\` in the description
          5. Ensure the code follows existing patterns and style

          ### Build & Lint:
          - Your environment has Node.js 20, Go 1.23, and all dependencies pre-installed
          - Run \`cd web && npm run build\` to verify TypeScript compilation
          - Run \`cd web && npm run lint\` to check for lint errors
          - A local preview server is running at \`http://localhost:4173\`

          ### Testing:
          - Use Playwright to test the Netlify preview deployment
          - Get the Deploy Preview URL from the \`netlify[bot]\` comment
          - Post screenshots as proof that your fix works

          ### Guidelines:
          - Use TypeScript for frontend code
          - Use Go for backend code
          - Follow the patterns in existing code
          EOF
          )" || true

      - name: Update labels - copilot assigned
        if: steps.check_processing.outputs.already_processing != 'true' && steps.assign_copilot.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create label if it doesn't exist
          gh label create "ai-awaiting-fix" --repo "$REPO" --color "6f42c1" --description "Copilot is working on a fix" 2>/dev/null || true

          # Update status: remove processing, add awaiting fix
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-processing" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-awaiting-fix"

      - name: Handle Copilot trigger failed
        if: steps.check_processing.outputs.already_processing != 'true' && steps.assign_copilot.outputs.success != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create label if it doesn't exist
          gh label create "ai-needs-human" --repo "$REPO" --color "d93f0b" --description "AI automation unavailable - needs human intervention" 2>/dev/null || true

          # Update status: remove processing, add needs-human
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-processing" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-needs-human"

          # Add comment explaining the situation
          gh issue comment "$ISSUE" --repo "$REPO" --body "$(cat <<'EOF'
          âš ï¸ **Copilot Trigger Failed**

          The AI fix workflow was triggered, but failed to post the Copilot trigger comment.

          **Next steps:**
          - A maintainer can manually trigger Copilot by commenting `@copilot` on this issue
          - Or manually address this issue

          /cc @${{ github.repository_owner }}
          EOF
          )"

  # Update issue labels when Copilot's PR changes state
  update-issue-on-pr:
    if: |
      github.event_name == 'pull_request' &&
      (github.event.pull_request.user.login == 'Copilot' || contains(github.event.pull_request.user.login, 'copilot'))
    runs-on: ubuntu-latest

    steps:
      - name: Extract linked issue number
        id: issue
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Extract issue number from "Fixes owner/repo#123" or "Fixes #123"
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oP '(?:Fixes|Closes|Resolves)\s+(?:\S+)?#\K\d+' | head -1)
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "Found linked issue: #$ISSUE_NUM"

      - name: Update labels on PR opened (draft created)
        if: github.event.action == 'opened' && steps.issue.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"
          PR_NUM="${{ github.event.pull_request.number }}"

          # Create labels if they don't exist
          gh label create "ai-pr-draft" --repo "$REPO" --color "1d76db" --description "Copilot has created a draft PR" 2>/dev/null || true
          gh label create "ai-generated" --repo "$REPO" --color "6f42c1" --description "This PR was generated by AI" 2>/dev/null || true

          # Add ai-generated label to the PR and remove DCO label (bot commits are auto-overridden)
          gh pr edit "$PR_NUM" --repo "$REPO" --add-label "ai-generated" 2>/dev/null || true
          gh pr edit "$PR_NUM" --repo "$REPO" --remove-label "dco-signoff: no" 2>/dev/null || true

          # Update issue status
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-awaiting-fix" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-pr-draft"

          echo "Updated issue #$ISSUE: ai-pr-draft, PR #$PR_NUM: ai-generated"

      - name: Remove DCO label on PR sync (bot commits are auto-overridden)
        if: github.event.action == 'synchronize'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          gh pr edit "$PR_NUM" --repo "${{ github.repository }}" --remove-label "dco-signoff: no" 2>/dev/null || true
          echo "Removed dco-signoff: no label from PR #$PR_NUM"

      - name: Update labels on PR ready for review
        if: github.event.action == 'ready_for_review' && steps.issue.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"
          PR_NUM="${{ github.event.pull_request.number }}"

          # Create label if it doesn't exist
          gh label create "ai-pr-ready" --repo "$REPO" --color "0e8a16" --description "Copilot PR is ready for review" 2>/dev/null || true

          # Update PR title: replace [WIP] with ðŸ¤– or just clean it up
          CURRENT_TITLE="${{ github.event.pull_request.title }}"
          NEW_TITLE=$(echo "$CURRENT_TITLE" | sed 's/^\[WIP\] */ðŸ¤– [REVIEW] /')
          if [ "$NEW_TITLE" != "$CURRENT_TITLE" ]; then
            gh api repos/$REPO/pulls/$PR_NUM -X PATCH -f title="$NEW_TITLE"
            echo "Updated PR title: $NEW_TITLE"
          fi

          # Get issue author and assign to PR via Prow command
          ISSUE_AUTHOR=$(gh api repos/$REPO/issues/$ISSUE --jq '.user.login')
          if [ -n "$ISSUE_AUTHOR" ]; then
            gh pr comment "$PR_NUM" --repo "$REPO" --body "/assign @$ISSUE_AUTHOR"
            echo "Assigned issue author @$ISSUE_AUTHOR to PR #$PR_NUM"
          fi

          # Remove WIP label from PR
          gh pr edit "$PR_NUM" --repo "$REPO" --remove-label "do-not-merge/work-in-progress" 2>/dev/null || true

          # Update issue status
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-pr-draft" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-awaiting-fix" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-pr-ready"

          echo "Updated issue #$ISSUE: ai-pr-ready, removed WIP label from PR #$PR_NUM"

      - name: Update labels on PR merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && steps.issue.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create label if it doesn't exist (use existing label name for UI compatibility)
          gh label create "ai-processing-complete" --repo "$REPO" --color "10B981" --description "AI automation has processed this issue" 2>/dev/null || true

          # Update status - remove all ai- labels and add complete
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-pr-ready" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-pr-draft" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-awaiting-fix" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-processing-complete"

          echo "Updated issue #$ISSUE: ai-processing-complete"

  # Handle build failures on Copilot PRs
  handle-build-failure:
    if: |
      github.event_name == 'pull_request' &&
      (github.event.pull_request.user.login == 'Copilot' || contains(github.event.pull_request.user.login, 'copilot')) &&
      github.event.action == 'synchronize'
    runs-on: ubuntu-latest

    steps:
      - name: Wait for Netlify check to complete
        id: wait_netlify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          MAX_ATTEMPTS=30
          ATTEMPT=0

          echo "Waiting for Netlify check on commit $COMMIT_SHA..."

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS"

            # Get check runs for the commit
            CHECK_STATUS=$(gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/check-runs \
              --jq '.check_runs[] | select(.name | contains("netlify") or contains("deploy-preview")) | {name: .name, status: .status, conclusion: .conclusion}' 2>/dev/null || echo "")

            if [ -n "$CHECK_STATUS" ]; then
              echo "Check status: $CHECK_STATUS"

              # Check if any check has completed
              COMPLETED=$(echo "$CHECK_STATUS" | jq -r 'select(.status == "completed")' 2>/dev/null || echo "")
              if [ -n "$COMPLETED" ]; then
                CONCLUSION=$(echo "$COMPLETED" | jq -r '.conclusion' | head -1)
                echo "netlify_conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
                echo "Netlify check completed with: $CONCLUSION"
                exit 0
              fi
            fi

            sleep 20
          done

          echo "Timeout waiting for Netlify check"
          echo "netlify_conclusion=timeout" >> $GITHUB_OUTPUT

      - name: Comment on PR if build failed
        if: steps.wait_netlify.outputs.netlify_conclusion == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<'EOF'
          ## âš ï¸ BUILD FAILED - YOU MUST FIX THIS

          @Copilot The build has **FAILED**. **You MUST fix these errors before this PR can be merged.**

          ### Required Actions:
          1. **Check the build logs** for the specific error (click the failing check)
          2. **Fix the code issues** - common problems include:
             - TypeScript errors (unused imports, type mismatches)
             - Missing dependencies
             - Syntax errors
          3. **Commit and push the fix**
          4. **Wait for the build to pass**

          ### After Build Passes:
          1. Wait for Netlify deploy preview to be ready
          2. Run Playwright tests on the preview URL
          3. **Post screenshots as proof that your fix works**

          â›” **The build MUST pass and you MUST post proof screenshots before this PR can be reviewed or merged.**
          EOF
          )"

          echo "Posted build failure comment on PR #$PR_NUM"

      - name: Mark PR ready if build passes and PR is draft
        if: steps.wait_netlify.outputs.netlify_conclusion == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          # Check if PR is still a draft
          IS_DRAFT=$(gh pr view "$PR_NUM" --repo "$REPO" --json isDraft --jq '.isDraft')

          if [ "$IS_DRAFT" = "true" ]; then
            echo "PR #$PR_NUM is a draft with passing build, marking as ready..."
            gh pr ready "$PR_NUM" --repo "$REPO"

            # Also clean up labels
            gh pr edit "$PR_NUM" --repo "$REPO" --remove-label "do-not-merge/work-in-progress" 2>/dev/null || true
            gh pr edit "$PR_NUM" --repo "$REPO" --remove-label "dco-signoff: no" 2>/dev/null || true

            echo "Marked PR #$PR_NUM as ready for review"
          else
            echo "PR #$PR_NUM is not a draft, no action needed"
          fi

  # Monitor for Copilot errors and ask for retry
  handle-copilot-error:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.action == 'created' &&
      (github.event.comment.user.login == 'copilot-swe-agent' || github.event.comment.user.login == 'Copilot') &&
      github.event.issue.pull_request
    runs-on: ubuntu-latest

    steps:
      - name: Check if comment contains error
        id: check_error
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Check for common error patterns in Copilot's response
          if echo "$COMMENT_BODY" | grep -qiE "(error|failed|unable to|cannot|exception|timeout|ECONNREFUSED|ETIMEDOUT|ERR_|net::ERR|playwright.*error)"; then
            echo "has_error=true" >> $GITHUB_OUTPUT
            echo "Detected potential error in Copilot's comment"
          else
            echo "has_error=false" >> $GITHUB_OUTPUT
            echo "No error detected"
          fi

      - name: Ask Copilot to retry on error
        if: steps.check_error.outputs.has_error == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.issue.number }}"

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<'EOF'
          ## ðŸ”„ Error Detected - Please Retry

          @Copilot It looks like you encountered an error. Please try again:

          1. **If it's a network/timeout error:** Wait a moment and retry the operation
          2. **If it's a Playwright error:** Make sure you're using the correct preview URL from the Netlify bot comment
          3. **If it's a code error:** Fix the issue and try again

          ### Preview URL
          Get the Deploy Preview URL from the `netlify[bot]` comment that says "Deploy Preview ready!"
          The URL format is: `https://deploy-preview-XX.console-deploy-preview.kubestellar.io`

          ### Requirements:
          - Run Playwright tests on the preview deployment
          - Take screenshots showing the feature works
          - Post the screenshots as proof

          Please try again and report your results.
          EOF
          )"

          echo "Posted retry request on PR #$PR_NUM"
