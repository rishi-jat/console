name: AI Fix with Copilot

on:
  issues:
    types: [labeled]
  pull_request:
    types: [opened, ready_for_review, closed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number
      issue_title:
        description: 'Issue title (optional, for display)'
        required: false
        type: string

run-name: "AI Fix #${{ github.event.inputs.issue_number || github.event.issue.number }}: ${{ github.event.inputs.issue_title || github.event.issue.title || 'Processing...' }}"

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  trigger-copilot:
    # Trigger when triage/accepted is added AND ai-fix-requested label exists, OR via manual dispatch
    if: |
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'triage/accepted' && contains(github.event.issue.labels.*.name, 'ai-fix-requested')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Set issue number
        id: issue
        run: |
          ISSUE_NUM="${{ github.event.inputs.issue_number || github.event.issue.number }}"
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Get issue details
        id: issue_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }})
          echo "title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_JSON" | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add rocket reaction to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/reactions \
            -X POST \
            -f content='rocket'

      - name: Update labels - processing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create labels if they don't exist
          gh label create "ai-processing" --repo "$REPO" --color "fbca04" --description "AI is currently processing this issue" 2>/dev/null || true
          gh label create "ai-fix-requested" --repo "$REPO" --color "d4c5f9" --description "AI fix has been requested" 2>/dev/null || true

          # Update status: remove requested, add processing
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-fix-requested" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-processing"

      - name: Assign Copilot to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          ISSUE_NUM="${{ steps.issue.outputs.number }}"

          # Get issue node ID
          ISSUE_ID=$(gh api graphql -f query="
            query {
              repository(owner: \"$REPO_OWNER\", name: \"$REPO_NAME\") {
                issue(number: $ISSUE_NUM) {
                  id
                }
              }
            }" --jq '.data.repository.issue.id')

          echo "Issue ID: $ISSUE_ID"

          # Get Copilot agent ID from suggested actors
          COPILOT_ID=$(gh api graphql -f query="
            query {
              repository(owner: \"$REPO_OWNER\", name: \"$REPO_NAME\") {
                issue(number: $ISSUE_NUM) {
                  suggestedActors(first: 10) {
                    nodes {
                      ... on Bot {
                        login
                        id
                      }
                    }
                  }
                }
              }
            }" --jq '.data.repository.issue.suggestedActors.nodes[] | select(.login == "copilot-swe-agent") | .id')

          echo "Copilot ID: $COPILOT_ID"

          if [ -z "$COPILOT_ID" ]; then
            echo "::warning::Copilot agent not found in suggested actors. Copilot may not be enabled for this repository."
            exit 0
          fi

          # Assign Copilot to the issue
          gh api graphql -f query="
            mutation {
              addAssigneesToAssignable(input: {
                assignableId: \"$ISSUE_ID\",
                assigneeIds: [\"$COPILOT_ID\"]
              }) {
                assignable {
                  ... on Issue {
                    assignees(first: 5) {
                      nodes {
                        login
                      }
                    }
                  }
                }
              }
            }"

          echo "Copilot assigned to issue #$ISSUE_NUM"

      - name: Update labels - copilot triggered
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create completion label if it doesn't exist
          gh label create "ai-awaiting-fix" --repo "$REPO" --color "6f42c1" --description "Awaiting Copilot response" 2>/dev/null || true

          # Update status: remove processing, add awaiting copilot
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-processing" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-awaiting-fix"

  # Update issue labels when Copilot's PR changes state
  update-issue-on-pr:
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.user.login, 'copilot-swe-agent')
    runs-on: ubuntu-latest

    steps:
      - name: Extract linked issue number
        id: issue
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Extract issue number from "Fixes owner/repo#123" or "Fixes #123"
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oP '(?:Fixes|Closes|Resolves)\s+(?:\S+)?#\K\d+' | head -1)
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "Found linked issue: #$ISSUE_NUM"

      - name: Update labels on PR opened (draft created)
        if: github.event.action == 'opened' && steps.issue.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"
          PR_NUM="${{ github.event.pull_request.number }}"

          # Create labels if they don't exist
          gh label create "ai-pr-draft" --repo "$REPO" --color "1d76db" --description "Copilot has created a draft PR" 2>/dev/null || true
          gh label create "ai-generated" --repo "$REPO" --color "6f42c1" --description "This PR was generated by AI" 2>/dev/null || true

          # Add ai-generated label to the PR
          gh pr edit "$PR_NUM" --repo "$REPO" --add-label "ai-generated" 2>/dev/null || true

          # Update issue status
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-awaiting-fix" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-pr-draft"

          echo "Updated issue #$ISSUE: ai-pr-draft, PR #$PR_NUM: ai-generated"

      - name: Update labels on PR ready for review
        if: github.event.action == 'ready_for_review' && steps.issue.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"
          PR_NUM="${{ github.event.pull_request.number }}"

          # Create label if it doesn't exist
          gh label create "ai-pr-ready" --repo "$REPO" --color "0e8a16" --description "Copilot PR is ready for review" 2>/dev/null || true

          # Update PR title: replace [WIP] with ðŸ¤– or just clean it up
          CURRENT_TITLE="${{ github.event.pull_request.title }}"
          NEW_TITLE=$(echo "$CURRENT_TITLE" | sed 's/^\[WIP\] */ðŸ¤– [REVIEW] /')
          if [ "$NEW_TITLE" != "$CURRENT_TITLE" ]; then
            gh api repos/$REPO/pulls/$PR_NUM -X PATCH -f title="$NEW_TITLE"
            echo "Updated PR title: $NEW_TITLE"
          fi

          # Get issue author and assign to PR via Prow command
          ISSUE_AUTHOR=$(gh api repos/$REPO/issues/$ISSUE --jq '.user.login')
          if [ -n "$ISSUE_AUTHOR" ]; then
            gh pr comment "$PR_NUM" --repo "$REPO" --body "/assign @$ISSUE_AUTHOR"
            echo "Assigned issue author @$ISSUE_AUTHOR to PR #$PR_NUM"
          fi

          # Update issue status
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-pr-draft" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-awaiting-fix" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-pr-ready"

          echo "Updated issue #$ISSUE: ai-pr-ready"

      - name: Update labels on PR merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && steps.issue.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create label if it doesn't exist (use existing label name for UI compatibility)
          gh label create "ai-processing-complete" --repo "$REPO" --color "10B981" --description "AI automation has processed this issue" 2>/dev/null || true

          # Update status - remove all ai- labels and add complete
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-pr-ready" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-pr-draft" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-awaiting-fix" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-processing-complete"

          echo "Updated issue #$ISSUE: ai-processing-complete"
