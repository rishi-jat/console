name: AI Fix with Claude Code

on:
  issues:
    types: [labeled, opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ai-fix:
    if: |
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'triage/accepted' && contains(github.event.issue.labels.*.name, 'ai-fix-requested')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Add rocket reaction to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -X POST \
            -f content='rocket'

      - name: Comment on issue start
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body "ðŸš€ Claude Code is analyzing this issue and working on a fix. I'll update you when I have results!"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install dependencies
        run: |
          cd web && npm ci
          go mod download

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "$(npm bin -g)" >> $GITHUB_PATH

      - name: Create fix branch
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@kubestellar.io"
          git checkout -b "ai-fix/issue-${{ github.event.issue.number }}"

      - name: Run Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Create prompt directly without heredoc
          PROMPT="You are fixing a bug or implementing a feature request for the KubeStellar Console project.

          Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          Description:
          ${ISSUE_BODY}

          Instructions:
          1. Analyze the codebase to understand the issue
          2. Implement a fix or feature as described
          3. Make minimal, focused changes
          4. Ensure the code compiles and follows project patterns
          5. Add any necessary tests
          6. Do not create markdown documentation files

          The project structure:
          - /web: React 18 + TypeScript + Vite frontend
          - /pkg: Go backend with Fiber framework
          - /pkg/api: API handlers
          - /pkg/store: SQLite data store
          - /pkg/models: Data models

          Please implement the fix now."

          # Run Claude Code in non-interactive mode using npx
          npx -y @anthropic-ai/claude-code --print "$PROMPT" || true

      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add -A
          git commit -s -m "ðŸ¤– fix: Address issue #${{ github.event.issue.number }}

          AI-generated fix for: ${{ github.event.issue.title }}

          Closes #${{ github.event.issue.number }}

          Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
          git push origin "ai-fix/issue-${{ github.event.issue.number }}"

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract Console Request ID from issue body if present
          CONSOLE_REQUEST_ID=$(echo "${{ github.event.issue.body }}" | grep -oP 'Console Request ID:\*\* \K[0-9a-f-]{36}' || echo "")

          # Build PR body with optional Console Request ID
          PR_BODY="## AI-Generated Fix

          This PR was automatically generated by Claude Code to address:
          - Issue: #${{ github.event.issue.number }}
          - Title: ${{ github.event.issue.title }}"

          if [ -n "$CONSOLE_REQUEST_ID" ]; then
            PR_BODY="$PR_BODY
          - **Console Request ID:** $CONSOLE_REQUEST_ID"
          fi

          PR_BODY="$PR_BODY

          ### What Changed
          See the commit diff for details on the changes made.

          ### Testing
          - [ ] Verify the fix works as expected
          - [ ] Check the Netlify preview deployment
          - [ ] Review code changes

          ### User Feedback
          The user who submitted this request will be notified when the preview is ready.

          ---
          *Generated by Claude Code*"

          gh pr create \
            --title "ðŸ¤– fix: ${{ github.event.issue.title }}" \
            --body "$PR_BODY" \
            --label "ai-generated"

      - name: Comment on issue - success
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "A fix has been generated and a pull request has been created. You will be notified when a preview deployment is ready for testing.

          Check the linked PR for details on the changes."

      - name: Comment on issue - no changes
        if: steps.check_changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "Claude Code analyzed this issue but couldn't determine the necessary changes automatically. A human developer will review this issue.

          This could happen because:
          - The issue description needs more detail
          - The fix requires complex architectural changes
          - The issue may already be resolved

          We'll update you when there's progress."

      - name: Remove label on completion
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} --remove-label "ai-fix-requested"
          gh issue edit ${{ github.event.issue.number }} --add-label "ai-processing-complete"
