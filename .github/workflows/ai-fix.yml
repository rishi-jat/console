name: AI Fix with Copilot
# Automates AI-assisted issue resolution via GitHub Copilot

on:
  issues:
    types: [labeled]
  pull_request:
    types: [opened, ready_for_review, closed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: string
      issue_title:
        description: 'Issue title (optional, for display)'
        required: false
        type: string

run-name: "AI Fix #${{ github.event.inputs.issue_number || github.event.issue.number }}: ${{ github.event.inputs.issue_title || github.event.issue.title || 'Processing...' }}"

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  trigger-copilot:
    # Trigger when triage/accepted is added AND ai-fix-requested label exists, OR via manual dispatch
    if: |
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'triage/accepted' && contains(github.event.issue.labels.*.name, 'ai-fix-requested')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Set issue number
        id: issue
        run: |
          ISSUE_NUM="${{ github.event.inputs.issue_number || github.event.issue.number }}"
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Get issue details
        id: issue_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }})
          echo "title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_JSON" | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add rocket reaction to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/reactions \
            -X POST \
            -f content='rocket'

      - name: Update labels - processing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create labels if they don't exist
          gh label create "ai-processing" --repo "$REPO" --color "fbca04" --description "AI is currently processing this issue" 2>/dev/null || true
          gh label create "ai-fix-requested" --repo "$REPO" --color "d4c5f9" --description "AI fix has been requested" 2>/dev/null || true

          # Update status: remove requested, add processing
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-fix-requested" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-processing"

      - name: Assign Copilot to issue
        id: assign_copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          ISSUE_NUM="${{ steps.issue.outputs.number }}"

          echo "Assigning Copilot to issue #$ISSUE_NUM..."

          # Get the issue node ID for GraphQL
          ISSUE_NODE_ID=$(gh api graphql -f query="
            query {
              repository(owner: \"$REPO_OWNER\", name: \"$REPO_NAME\") {
                issue(number: $ISSUE_NUM) {
                  id
                }
              }
            }" --jq '.data.repository.issue.id')

          echo "Issue node ID: $ISSUE_NODE_ID"

          # Copilot's node ID (this is constant for GitHub Copilot coding agent)
          COPILOT_NODE_ID="BOT_kgDOC9w8XQ"

          # Assign Copilot using GraphQL mutation (REST API doesn't work for bots)
          echo "Attempting to assign Copilot (node ID: $COPILOT_NODE_ID) to issue (node ID: $ISSUE_NODE_ID)..."

          ASSIGN_RESULT=$(gh api graphql -f query="
            mutation {
              addAssigneesToAssignable(input: {
                assignableId: \"$ISSUE_NODE_ID\"
                assigneeIds: [\"$COPILOT_NODE_ID\"]
              }) {
                assignable {
                  ... on Issue {
                    assignees(first: 10) {
                      nodes {
                        login
                      }
                    }
                  }
                }
              }
            }" 2>&1) && ASSIGN_SUCCESS=true || ASSIGN_SUCCESS=false

          echo "GraphQL response: $ASSIGN_RESULT"
          echo "GraphQL success: $ASSIGN_SUCCESS"

          # Check if Copilot was successfully assigned (handle JSON with or without spaces)
          if echo "$ASSIGN_RESULT" | grep -qE '"login"\s*:\s*"Copilot"'; then
            echo "Successfully assigned Copilot to issue #$ISSUE_NUM"
            echo "copilot_assigned=true" >> $GITHUB_OUTPUT

            # Also post a comment with instructions for Copilot
            gh issue comment "$ISSUE_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## ðŸ¤– AI Fix Requested

          @Copilot Please analyze this issue and create a fix.

          ### Instructions:
          1. Read the issue description carefully
          2. Explore the codebase to understand the context
          3. Implement the requested changes
          4. Create a PR with \`Fixes #$ISSUE_NUM\` in the description
          5. Ensure the code follows existing patterns and style

          ### Guidelines:
          - Follow the patterns in existing code
          - Add appropriate tests if applicable
          - Keep changes focused on the issue scope
          - Use TypeScript for frontend code
          - Use Go for backend code

          ### Testing Requirements:
          - **You MUST use Playwright to test the preview deployment**
          - **Get the Deploy Preview URL from the Netlify bot comment on your PR**
            - Look for the comment from \`netlify[bot]\` with "Deploy Preview ready!"
            - Use the URL ending in \`.kubestellar.io\` (e.g., \`https://deploy-preview-XX.console-deploy-preview.kubestellar.io\`)
          - Test all user interactions (clicks, inputs, etc.) that your changes affect
          - Verify the expected behavior occurs after each interaction
          - **IMPORTANT: Post screenshots as proof that your fix works**
            - Take screenshots showing the feature/fix in action
            - Post the screenshots as a comment on this PR
            - Include before/after screenshots if applicable
          EOF
          )" || true
          else
            echo "::warning::GraphQL assignment returned unexpected response. Trying comment trigger as fallback..."
            echo "Response was: $ASSIGN_RESULT"

            # Fallback: Try to trigger Copilot via @mention in a comment
            COMMENT_RESULT=$(gh issue comment "$ISSUE_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## ðŸ¤– AI Fix Requested

          @Copilot Please analyze this issue and create a fix.

          ### Instructions:
          1. Read the issue description carefully
          2. Explore the codebase to understand the context
          3. Implement the requested changes
          4. Create a PR with \`Fixes #$ISSUE_NUM\` in the description
          5. Ensure the code follows existing patterns and style

          ### Guidelines:
          - Follow the patterns in existing code
          - Add appropriate tests if applicable
          - Keep changes focused on the issue scope
          - Use TypeScript for frontend code
          - Use Go for backend code

          ### Testing Requirements:
          - **You MUST use Playwright to test the preview deployment**
          - **Get the Deploy Preview URL from the Netlify bot comment on your PR**
            - Look for the comment from \`netlify[bot]\` with "Deploy Preview ready!"
            - Use the URL ending in \`.kubestellar.io\` (e.g., \`https://deploy-preview-XX.console-deploy-preview.kubestellar.io\`)
          - Test all user interactions (clicks, inputs, etc.) that your changes affect
          - Verify the expected behavior occurs after each interaction
          - **IMPORTANT: Post screenshots as proof that your fix works**
            - Take screenshots showing the feature/fix in action
            - Post the screenshots as a comment on this PR
            - Include before/after screenshots if applicable
          EOF
          )" 2>&1) && COMMENT_SUCCESS=true || COMMENT_SUCCESS=false

            if [ "$COMMENT_SUCCESS" = "true" ]; then
              echo "Posted @Copilot comment as fallback trigger"
              echo "copilot_assigned=true" >> $GITHUB_OUTPUT
            else
              echo "::error::Both GraphQL assignment and comment fallback failed"
              echo "Comment result: $COMMENT_RESULT"
              echo "copilot_assigned=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Update labels - copilot assigned
        if: steps.assign_copilot.outputs.copilot_assigned == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create label if it doesn't exist
          gh label create "ai-awaiting-fix" --repo "$REPO" --color "6f42c1" --description "Copilot is working on a fix" 2>/dev/null || true

          # Update status: remove processing, add awaiting fix
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-processing" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-awaiting-fix"

      - name: Handle Copilot trigger failed
        if: steps.assign_copilot.outputs.copilot_assigned != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create label if it doesn't exist
          gh label create "ai-needs-human" --repo "$REPO" --color "d93f0b" --description "AI automation unavailable - needs human intervention" 2>/dev/null || true

          # Update status: remove processing, add needs-human
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-processing" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-needs-human"

          # Add comment explaining the situation
          gh issue comment "$ISSUE" --repo "$REPO" --body "$(cat <<'EOF'
          âš ï¸ **Copilot Trigger Failed**

          The AI fix workflow was triggered, but failed to post the Copilot trigger comment.

          **Next steps:**
          - A maintainer can manually trigger Copilot by commenting `@copilot` on this issue
          - Or manually address this issue

          /cc @${{ github.repository_owner }}
          EOF
          )"

  # Update issue labels when Copilot's PR changes state
  update-issue-on-pr:
    if: |
      github.event_name == 'pull_request' &&
      (github.event.pull_request.user.login == 'Copilot' || contains(github.event.pull_request.user.login, 'copilot'))
    runs-on: ubuntu-latest

    steps:
      - name: Extract linked issue number
        id: issue
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Extract issue number from "Fixes owner/repo#123" or "Fixes #123"
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oP '(?:Fixes|Closes|Resolves)\s+(?:\S+)?#\K\d+' | head -1)
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "Found linked issue: #$ISSUE_NUM"

      - name: Update labels on PR opened (draft created)
        if: github.event.action == 'opened' && steps.issue.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"
          PR_NUM="${{ github.event.pull_request.number }}"

          # Create labels if they don't exist
          gh label create "ai-pr-draft" --repo "$REPO" --color "1d76db" --description "Copilot has created a draft PR" 2>/dev/null || true
          gh label create "ai-generated" --repo "$REPO" --color "6f42c1" --description "This PR was generated by AI" 2>/dev/null || true

          # Add ai-generated label to the PR and remove DCO label (bot commits are auto-overridden)
          gh pr edit "$PR_NUM" --repo "$REPO" --add-label "ai-generated" 2>/dev/null || true
          gh pr edit "$PR_NUM" --repo "$REPO" --remove-label "dco-signoff: no" 2>/dev/null || true

          # Update issue status
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-awaiting-fix" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-pr-draft"

          echo "Updated issue #$ISSUE: ai-pr-draft, PR #$PR_NUM: ai-generated"

      - name: Remove DCO label on PR sync (bot commits are auto-overridden)
        if: github.event.action == 'synchronize'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          gh pr edit "$PR_NUM" --repo "${{ github.repository }}" --remove-label "dco-signoff: no" 2>/dev/null || true
          echo "Removed dco-signoff: no label from PR #$PR_NUM"

      - name: Update labels on PR ready for review
        if: github.event.action == 'ready_for_review' && steps.issue.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"
          PR_NUM="${{ github.event.pull_request.number }}"

          # Create label if it doesn't exist
          gh label create "ai-pr-ready" --repo "$REPO" --color "0e8a16" --description "Copilot PR is ready for review" 2>/dev/null || true

          # Update PR title: replace [WIP] with ðŸ¤– or just clean it up
          CURRENT_TITLE="${{ github.event.pull_request.title }}"
          NEW_TITLE=$(echo "$CURRENT_TITLE" | sed 's/^\[WIP\] */ðŸ¤– [REVIEW] /')
          if [ "$NEW_TITLE" != "$CURRENT_TITLE" ]; then
            gh api repos/$REPO/pulls/$PR_NUM -X PATCH -f title="$NEW_TITLE"
            echo "Updated PR title: $NEW_TITLE"
          fi

          # Get issue author and assign to PR via Prow command
          ISSUE_AUTHOR=$(gh api repos/$REPO/issues/$ISSUE --jq '.user.login')
          if [ -n "$ISSUE_AUTHOR" ]; then
            gh pr comment "$PR_NUM" --repo "$REPO" --body "/assign @$ISSUE_AUTHOR"
            echo "Assigned issue author @$ISSUE_AUTHOR to PR #$PR_NUM"
          fi

          # Remove WIP label from PR
          gh pr edit "$PR_NUM" --repo "$REPO" --remove-label "do-not-merge/work-in-progress" 2>/dev/null || true

          # Update issue status
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-pr-draft" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-awaiting-fix" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-pr-ready"

          echo "Updated issue #$ISSUE: ai-pr-ready, removed WIP label from PR #$PR_NUM"

      - name: Update labels on PR merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true && steps.issue.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create label if it doesn't exist (use existing label name for UI compatibility)
          gh label create "ai-processing-complete" --repo "$REPO" --color "10B981" --description "AI automation has processed this issue" 2>/dev/null || true

          # Update status - remove all ai- labels and add complete
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-pr-ready" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-pr-draft" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-awaiting-fix" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-processing-complete"

          echo "Updated issue #$ISSUE: ai-processing-complete"

  # Handle build failures on Copilot PRs
  handle-build-failure:
    if: |
      github.event_name == 'pull_request' &&
      (github.event.pull_request.user.login == 'Copilot' || contains(github.event.pull_request.user.login, 'copilot')) &&
      github.event.action == 'synchronize'
    runs-on: ubuntu-latest

    steps:
      - name: Wait for Netlify check to complete
        id: wait_netlify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          MAX_ATTEMPTS=30
          ATTEMPT=0

          echo "Waiting for Netlify check on commit $COMMIT_SHA..."

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS"

            # Get check runs for the commit
            CHECK_STATUS=$(gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/check-runs \
              --jq '.check_runs[] | select(.name | contains("netlify") or contains("deploy-preview")) | {name: .name, status: .status, conclusion: .conclusion}' 2>/dev/null || echo "")

            if [ -n "$CHECK_STATUS" ]; then
              echo "Check status: $CHECK_STATUS"

              # Check if any check has completed
              COMPLETED=$(echo "$CHECK_STATUS" | jq -r 'select(.status == "completed")' 2>/dev/null || echo "")
              if [ -n "$COMPLETED" ]; then
                CONCLUSION=$(echo "$COMPLETED" | jq -r '.conclusion' | head -1)
                echo "netlify_conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
                echo "Netlify check completed with: $CONCLUSION"
                exit 0
              fi
            fi

            sleep 20
          done

          echo "Timeout waiting for Netlify check"
          echo "netlify_conclusion=timeout" >> $GITHUB_OUTPUT

      - name: Comment on PR if build failed
        if: steps.wait_netlify.outputs.netlify_conclusion == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<'EOF'
          ## âš ï¸ Build Failed

          @Copilot The Netlify deploy preview build has **failed**. Please check the build logs and fix the errors.

          **Common issues to check:**
          - TypeScript compilation errors (unused imports, type mismatches)
          - Missing dependencies
          - Syntax errors

          **To fix:**
          1. Check the Netlify deploy logs for the specific error
          2. Fix the code issues
          3. Push a new commit

          The build must pass before this PR can be reviewed.
          EOF
          )"

          echo "Posted build failure comment on PR #$PR_NUM"

      - name: Mark PR ready if build passes and PR is draft
        if: steps.wait_netlify.outputs.netlify_conclusion == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          # Check if PR is still a draft
          IS_DRAFT=$(gh pr view "$PR_NUM" --repo "$REPO" --json isDraft --jq '.isDraft')

          if [ "$IS_DRAFT" = "true" ]; then
            echo "PR #$PR_NUM is a draft with passing build, marking as ready..."
            gh pr ready "$PR_NUM" --repo "$REPO"

            # Also clean up labels
            gh pr edit "$PR_NUM" --repo "$REPO" --remove-label "do-not-merge/work-in-progress" 2>/dev/null || true
            gh pr edit "$PR_NUM" --repo "$REPO" --remove-label "dco-signoff: no" 2>/dev/null || true

            echo "Marked PR #$PR_NUM as ready for review"
          else
            echo "PR #$PR_NUM is not a draft, no action needed"
          fi
