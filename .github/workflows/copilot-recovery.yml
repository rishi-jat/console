name: Copilot Error Recovery

on:
  check_run:
    types: [completed]
  workflow_run:
    workflows: ["Build and Deploy KC"]
    types: [completed]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  pull_request_target:
    types: [synchronize]  # Triggers when commits are pushed to PR
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to test'
        required: true
        type: string
      test_preview:
        description: 'Run preview test'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write
  statuses: write

concurrency:
  group: copilot-recovery-${{ github.event.check_run.pull_requests[0].number || github.event.pull_request.number || github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

jobs:
  # Gate job ensures the workflow always has at least one job that runs,
  # preventing GitHub from reporting "No jobs were run" as a failure
  # and sending noisy email notifications.
  gate:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Event ${{ github.event_name }} received"

  # Override DCO for bot PRs automatically
  override-dco-for-bots:
    if: |
      github.event_name == 'check_run' &&
      github.event.check_run.name == 'dco' &&
      github.event.check_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is from a bot
        id: check_bot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=$(echo '${{ toJson(github.event.check_run.pull_requests) }}' | jq -r '.[0].number')

          if [ -z "$PR_NUM" ] || [ "$PR_NUM" == "null" ]; then
            echo "No PR found"
            exit 0
          fi

          PR_AUTHOR=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM --jq '.user.login')
          echo "PR #$PR_NUM author: $PR_AUTHOR"

          if [[ "$PR_AUTHOR" == *"[bot]"* ]] || [[ "$PR_AUTHOR" == "Copilot" ]] || [[ "$PR_AUTHOR" == "copilot-swe-agent" ]] || [[ "$PR_AUTHOR" == "dependabot"* ]]; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.check_run.head_sha }}" >> $GITHUB_OUTPUT
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
          fi

      - name: Override DCO for bot
        if: steps.check_bot.outputs.is_bot == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.check_bot.outputs.pr_number }}"
          SHA="${{ steps.check_bot.outputs.sha }}"

          # Method 1: Set GitHub status (for GitHub native checks)
          gh api repos/${{ github.repository }}/statuses/$SHA \
            -X POST \
            -f state=success \
            -f context=dco \
            -f description="DCO automatically overridden for bot commits" || true

          # Method 2: Post Prow override command (for Prow-managed repos)
          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "/override dco"

          echo "DCO overridden for bot PR #$PR_NUM"

  # Handle build failures on Copilot PRs
  # Only trigger on "Deploy Preview" check to avoid duplicate comments from Netlify sub-checks
  handle-build-failure:
    if: |
      github.event_name == 'check_run' &&
      github.event.check_run.conclusion == 'failure' &&
      github.event.check_run.name != 'dco' &&
      !contains(github.event.check_run.name, 'Header rules') &&
      !contains(github.event.check_run.name, 'Redirect rules') &&
      !contains(github.event.check_run.name, 'Pages changed')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=$(echo '${{ toJson(github.event.check_run.pull_requests) }}' | jq -r '.[0].number')
          if [ -z "$PR_NUM" ] || [ "$PR_NUM" == "null" ]; then
            echo "No PR found"
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM)
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.draft')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')

          echo "PR #$PR_NUM author: $PR_AUTHOR, draft: $IS_DRAFT"

          if [[ "$PR_AUTHOR" == *"copilot"* ]] || [[ "$PR_AUTHOR" == "Copilot" ]]; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
            echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_copilot=false" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if already commented on this failure
        if: steps.pr_info.outputs.is_copilot == 'true'
        id: check_comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_info.outputs.pr_number }}"
          HEAD_SHA="${{ steps.pr_info.outputs.head_sha }}"

          # Check if we already posted a failure comment for this commit
          EXISTING=$(gh api repos/${{ github.repository }}/issues/$PR_NUM/comments --jq "[.[] | select(.body | contains(\"Build Failure Detected\") and contains(\"$HEAD_SHA\"))] | length")

          if [ "$EXISTING" -gt "0" ]; then
            echo "Already commented on build failure for commit $HEAD_SHA"
            echo "should_comment=false" >> $GITHUB_OUTPUT
          else
            echo "should_comment=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR about build failure
        if: steps.pr_info.outputs.is_copilot == 'true' && steps.check_comment.outputs.should_comment == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_info.outputs.pr_number }}"
          HEAD_SHA="${{ steps.pr_info.outputs.head_sha }}"
          CHECK_NAME="${{ github.event.check_run.name }}"
          CHECK_URL="${{ github.event.check_run.html_url }}"

          # Get the failure details
          DETAILS=$(gh api repos/${{ github.repository }}/check-runs/${{ github.event.check_run.id }} --jq '.output.summary // .output.text // "No details available"' | head -500)

          # Use heredoc for multiline comment to avoid YAML escaping issues
          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## üî¥ Build Failure Detected

          **Check:** $CHECK_NAME
          **Commit:** $HEAD_SHA
          **Status:** Failed
          **Details:** [View Check Run]($CHECK_URL)

          ### Error Summary
          $DETAILS

          ---
          @Copilot **ACTION REQUIRED:** The build has failed. You must fix this immediately.

          **Steps to fix:**
          1. Run \`cd web && npm run build\` locally to see the exact TypeScript errors
          2. Fix ALL errors shown in the build output
          3. Common issues:
             - Unused imports (remove them)
             - Missing type definitions (add proper types)
             - \`NodeJS.Timeout\` should be \`ReturnType<typeof setTimeout>\`
          4. Push your fix to this PR
          5. Wait for the new build to pass

          **Do NOT respond until the build passes.** Just fix the code and push.

          *This comment was automatically generated by the Copilot Error Recovery workflow.*
          EOF
          )"
          echo "Posted failure comment on PR #$PR_NUM"

  # Handle successful builds - trigger preview testing
  # Netlify check runs are named like "Header rules - kubestellarconsole"
  handle-build-success:
    if: |
      github.event_name == 'check_run' &&
      github.event.check_run.conclusion == 'success' &&
      contains(github.event.check_run.name, 'kubestellarconsole')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=$(echo '${{ toJson(github.event.check_run.pull_requests) }}' | jq -r '.[0].number')
          if [ -z "$PR_NUM" ] || [ "$PR_NUM" == "null" ]; then
            echo "No PR found"
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM)
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.draft')
          PR_BODY=$(echo "$PR_DATA" | jq -r '.body')

          # Extract linked issue number
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oP '(?:Fixes|Closes|Resolves)\s+(?:\S+)?#\K\d+' | head -1)

          echo "PR #$PR_NUM author: $PR_AUTHOR, draft: $IS_DRAFT, linked issue: $ISSUE_NUM"

          if [[ "$PR_AUTHOR" == *"copilot"* ]] || [[ "$PR_AUTHOR" == "Copilot" ]]; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_copilot=false" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Get Netlify preview URL
        if: steps.pr_info.outputs.is_copilot == 'true'
        id: preview
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_info.outputs.pr_number }}"

          # Use custom domain (not blocked by Playwright like *.netlify.app)
          PREVIEW_URL="https://deploy-preview-${PR_NUM}.console-deploy-preview.kubestellar.io"

          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "Preview URL: $PREVIEW_URL"

      - name: Test preview deployment
        if: steps.pr_info.outputs.is_copilot == 'true'
        id: preview_test
        run: |
          PREVIEW_URL="${{ steps.preview.outputs.preview_url }}"

          echo "Testing preview: $PREVIEW_URL"

          # Wait for Netlify to be ready (up to 2 minutes)
          for i in {1..12}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL" --max-time 10 || echo "000")
            echo "Attempt $i: HTTP $HTTP_CODE"

            if [ "$HTTP_CODE" == "200" ]; then
              echo "preview_status=success" >> $GITHUB_OUTPUT
              break
            fi
            sleep 10
          done

          if [ "$HTTP_CODE" != "200" ]; then
            echo "preview_status=failed" >> $GITHUB_OUTPUT
            echo "Preview not accessible after 2 minutes"
          fi

          # Check for JavaScript errors by looking for common error patterns in HTML
          CONTENT=$(curl -s "$PREVIEW_URL" --max-time 30 || echo "")

          if echo "$CONTENT" | grep -qi "chunk.*failed\|module.*error\|syntax.*error"; then
            echo "js_errors=true" >> $GITHUB_OUTPUT
            echo "Detected potential JavaScript errors in page"
          else
            echo "js_errors=false" >> $GITHUB_OUTPUT
          fi

          # Check if React app renders (look for root element with content)
          if echo "$CONTENT" | grep -q 'id="root"' && [ ${#CONTENT} -gt 5000 ]; then
            echo "app_renders=true" >> $GITHUB_OUTPUT
          else
            echo "app_renders=maybe" >> $GITHUB_OUTPUT
            echo "Could not confirm app rendering - needs manual check"
          fi

      - name: Notify build success
        if: steps.pr_info.outputs.is_copilot == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_info.outputs.pr_number }}"
          ISSUE_NUM="${{ steps.pr_info.outputs.issue_number }}"
          PREVIEW_URL="${{ steps.preview.outputs.preview_url }}"
          PREVIEW_STATUS="${{ steps.preview_test.outputs.preview_status }}"
          JS_ERRORS="${{ steps.preview_test.outputs.js_errors }}"
          APP_RENDERS="${{ steps.preview_test.outputs.app_renders }}"

          # Build status message
          if [ "$PREVIEW_STATUS" == "success" ] && [ "$JS_ERRORS" == "false" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_MSG="Preview is accessible and appears healthy."
            NEEDS_FIX="false"
          elif [ "$PREVIEW_STATUS" == "failed" ]; then
            STATUS_EMOJI="‚ùå"
            STATUS_MSG="Preview URL is not accessible. Deployment may have failed."
            NEEDS_FIX="true"
          elif [ "$JS_ERRORS" == "true" ]; then
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_MSG="Preview is accessible but JavaScript errors were detected."
            NEEDS_FIX="true"
          else
            STATUS_EMOJI="‚úÖ"
            STATUS_MSG="Preview deployed successfully."
            NEEDS_FIX="false"
          fi

          # Use heredoc for multiline comment
          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## $STATUS_EMOJI Build & Preview Status

          **Netlify Preview:** $PREVIEW_URL

          ### Automated Test Results
          - **Preview accessible:** $([ "$PREVIEW_STATUS" == "success" ] && echo "‚úÖ Yes" || echo "‚ùå No")
          - **JavaScript errors:** $([ "$JS_ERRORS" == "true" ] && echo "‚ö†Ô∏è Detected" || echo "‚úÖ None detected")
          - **App renders:** $([ "$APP_RENDERS" == "true" ] && echo "‚úÖ Yes" || echo "‚ö†Ô∏è Needs verification")

          **Status:** $STATUS_MSG

          $(if [ "$NEEDS_FIX" == "true" ]; then echo "
          @copilot **ACTION REQUIRED:** The preview has issues. Please investigate and fix:
          1. Check for runtime errors in your code
          2. Run \`cd web && npm run build\` locally
          3. Push fixes and wait for new preview
          "; else echo "
          @copilot **Please verify the preview works:**

          1. Fetch the preview URL: \`curl -s $PREVIEW_URL\`
          2. Verify it returns HTML with \`<div id=\"root\">\`
          3. Check there are no error messages in the HTML
          4. Report your findings in a comment

          Once verified, the PR is ready for human review.
          "; fi)

          *This comment was automatically generated by the Copilot Error Recovery workflow.*
          EOF
          )"
          echo "Posted status notification on PR #$PR_NUM"

      - name: Auto-mark PR ready for review
        if: steps.pr_info.outputs.is_copilot == 'true' && steps.pr_info.outputs.is_draft == 'true'
        env:
          GH_TOKEN: ${{ secrets.CONSOLE_AUTO || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_info.outputs.pr_number }}"

          echo "Marking PR #$PR_NUM as ready for review..."

          # Use GraphQL to mark PR as ready (removes draft status)
          PR_NODE_ID=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM --jq '.node_id')

          gh api graphql -f query="
            mutation {
              markPullRequestReadyForReview(input: {pullRequestId: \"$PR_NODE_ID\"}) {
                pullRequest {
                  isDraft
                }
              }
            }"

          echo "PR #$PR_NUM marked as ready for review"

  # Handle workflow run completion (for more complex build pipelines)
  handle-workflow-completion:
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    steps:
      - name: Check workflow result
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"

          echo "Workflow '${{ github.event.workflow_run.name }}' completed with: $CONCLUSION"

          # Find PR for this commit
          PR_DATA=$(gh api repos/${{ github.repository }}/commits/$HEAD_SHA/pulls --jq '.[0]' 2>/dev/null || echo "")

          if [ -z "$PR_DATA" ] || [ "$PR_DATA" == "null" ]; then
            echo "No PR found for commit $HEAD_SHA"
            exit 0
          fi

          PR_NUM=$(echo "$PR_DATA" | jq -r '.number')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')

          echo "PR #$PR_NUM by $PR_AUTHOR"

          if [[ "$PR_AUTHOR" != *"copilot"* ]] && [[ "$PR_AUTHOR" != "Copilot" ]]; then
            echo "Not a Copilot PR, skipping"
            exit 0
          fi

          if [ "$CONCLUSION" == "failure" ]; then
            # Get workflow run logs URL
            RUN_URL="${{ github.event.workflow_run.html_url }}"
            WF_NAME="${{ github.event.workflow_run.name }}"

            # Post failure comment
            gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "## üî¥ Workflow Failed

**Workflow:** $WF_NAME
**Status:** Failed
**Details:** [View Workflow Run]($RUN_URL)

@copilot Please investigate the workflow failure and push fixes.

*This comment was automatically generated.*"
          fi

  # Handle code review feedback on Copilot PRs
  handle-review-feedback:
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested') ||
      github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is from Copilot
        id: check_copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_AUTHOR=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM --jq '.user.login')

          if [[ "$PR_AUTHOR" == *"copilot"* ]] || [[ "$PR_AUTHOR" == "Copilot" ]]; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          else
            echo "is_copilot=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Copilot of review feedback
        if: steps.check_copilot.outputs.is_copilot == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.check_copilot.outputs.pr_number }}"
          REVIEWER="${{ github.event.review.user.login || github.event.comment.user.login }}"

          # Get the review/comment body
          if [ "${{ github.event_name }}" == "pull_request_review" ]; then
            FEEDBACK="${{ github.event.review.body }}"
            FEEDBACK_TYPE="review"
          else
            FEEDBACK="${{ github.event.comment.body }}"
            FEEDBACK_TYPE="comment"
          fi

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## üìù Code Review Feedback Received

          **Reviewer:** @$REVIEWER
          **Type:** $FEEDBACK_TYPE

          @copilot A reviewer has provided feedback on your PR. Please:

          1. **Read and understand** the feedback above
          2. **Address all requested changes**
          3. **Push commits** with the fixes
          4. **Reply** to confirm the changes have been made

          If you disagree with any feedback, explain your reasoning in a reply.

          ---
          *This notification was automatically generated.*
          EOF
          )"

  # Manual preview test (triggered via workflow_dispatch)
  manual-preview-test:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_preview == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Test preview deployment
        id: preview_test
        run: |
          PR_NUM="${{ github.event.inputs.pr_number }}"
          PREVIEW_URL="https://deploy-preview-${PR_NUM}.console-deploy-preview.kubestellar.io"

          echo "Testing preview for PR #$PR_NUM: $PREVIEW_URL"

          # Wait for Netlify to be ready (up to 2 minutes)
          for i in {1..12}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL" --max-time 10 || echo "000")
            echo "Attempt $i: HTTP $HTTP_CODE"

            if [ "$HTTP_CODE" == "200" ]; then
              echo "preview_status=success" >> $GITHUB_OUTPUT
              echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
              break
            fi
            sleep 10
          done

          if [ "$HTTP_CODE" != "200" ]; then
            echo "preview_status=failed" >> $GITHUB_OUTPUT
            echo "Preview not accessible after 2 minutes"
          fi

          # Check for JavaScript errors
          CONTENT=$(curl -s "$PREVIEW_URL" --max-time 30 || echo "")

          if echo "$CONTENT" | grep -qi "chunk.*failed\|module.*error\|syntax.*error"; then
            echo "js_errors=true" >> $GITHUB_OUTPUT
          else
            echo "js_errors=false" >> $GITHUB_OUTPUT
          fi

          # Check if React app renders
          if echo "$CONTENT" | grep -q 'id="root"' && [ ${#CONTENT} -gt 5000 ]; then
            echo "app_renders=true" >> $GITHUB_OUTPUT
          else
            echo "app_renders=maybe" >> $GITHUB_OUTPUT
          fi

      - name: Post test results
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.inputs.pr_number }}"
          PREVIEW_URL="https://deploy-preview-${PR_NUM}.console-deploy-preview.kubestellar.io"
          PREVIEW_STATUS="${{ steps.preview_test.outputs.preview_status }}"
          JS_ERRORS="${{ steps.preview_test.outputs.js_errors }}"
          APP_RENDERS="${{ steps.preview_test.outputs.app_renders }}"

          # Build status message
          if [ "$PREVIEW_STATUS" == "success" ] && [ "$JS_ERRORS" == "false" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_MSG="Preview is accessible and appears healthy."
          elif [ "$PREVIEW_STATUS" == "failed" ]; then
            STATUS_EMOJI="‚ùå"
            STATUS_MSG="Preview URL is not accessible."
          elif [ "$JS_ERRORS" == "true" ]; then
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_MSG="Preview has JavaScript errors."
          else
            STATUS_EMOJI="‚úÖ"
            STATUS_MSG="Preview deployed successfully."
          fi

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## $STATUS_EMOJI Manual Preview Test Results

          **Preview:** $PREVIEW_URL

          - **Accessible:** $([ "$PREVIEW_STATUS" == "success" ] && echo "‚úÖ Yes" || echo "‚ùå No")
          - **JS Errors:** $([ "$JS_ERRORS" == "true" ] && echo "‚ö†Ô∏è Detected" || echo "‚úÖ None")
          - **App Renders:** $([ "$APP_RENDERS" == "true" ] && echo "‚úÖ Yes" || echo "‚ö†Ô∏è Needs verification")

          **Status:** $STATUS_MSG

          *Manual test triggered via workflow_dispatch*
          EOF
          )"

  # Auto-request Copilot to test preview when commits are pushed
  request-copilot-preview-test:
    if: github.event_name == 'pull_request_target' && github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is from Copilot
        id: check_copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"

          echo "PR #$PR_NUM author: $PR_AUTHOR"

          if [[ "$PR_AUTHOR" == *"copilot"* ]] || [[ "$PR_AUTHOR" == "Copilot" ]]; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          else
            echo "is_copilot=false" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Netlify deploy
        if: steps.check_copilot.outputs.is_copilot == 'true'
        run: |
          echo "Waiting 90 seconds for Netlify to build and deploy..."
          sleep 90

      - name: Test preview and request Copilot verification
        if: steps.check_copilot.outputs.is_copilot == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.check_copilot.outputs.pr_number }}"
          PREVIEW_URL="https://deploy-preview-${PR_NUM}.console-deploy-preview.kubestellar.io"

          echo "Testing preview: $PREVIEW_URL"

          # Test if preview is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL" --max-time 30 || echo "000")

          if [ "$HTTP_CODE" == "200" ]; then
            # Preview is ready - ask Copilot to verify
            gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## üîç Preview Ready - Verification Required

          @copilot New commit detected. Please verify the preview deployment:

          1. **Fetch the preview:**
             \`\`\`bash
             curl -s $PREVIEW_URL
             \`\`\`

          2. **Verify the response contains:**
             - \`<div id="root">\` (React mount point)
             - JavaScript and CSS bundle references
             - No error messages

          3. **Report your findings** confirming the preview works.

          **Preview URL:** $PREVIEW_URL
          EOF
          )"
            echo "Posted verification request for PR #$PR_NUM"
          else
            echo "Preview not ready yet (HTTP $HTTP_CODE), skipping verification request"
          fi
