name: Copilot Error Recovery

on:
  check_run:
    types: [completed]
  workflow_run:
    workflows: ["Build and Deploy KKC"]
    types: [completed]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  statuses: write

jobs:
  # Override DCO for bot PRs automatically
  override-dco-for-bots:
    if: |
      github.event_name == 'check_run' &&
      github.event.check_run.name == 'dco' &&
      github.event.check_run.conclusion == 'failure' &&
      contains(github.event.check_run.pull_requests.*.head.repo.full_name, github.repository)
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is from a bot
        id: check_bot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=$(echo '${{ toJson(github.event.check_run.pull_requests) }}' | jq -r '.[0].number')
          if [ -z "$PR_NUM" ] || [ "$PR_NUM" == "null" ]; then
            echo "No PR found"
            exit 0
          fi

          PR_AUTHOR=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM --jq '.user.login')
          echo "PR #$PR_NUM author: $PR_AUTHOR"

          if [[ "$PR_AUTHOR" == *"[bot]"* ]] || [[ "$PR_AUTHOR" == "Copilot" ]] || [[ "$PR_AUTHOR" == "copilot-swe-agent" ]] || [[ "$PR_AUTHOR" == "dependabot"* ]]; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
          fi

      - name: Override DCO for bot
        if: steps.check_bot.outputs.is_bot == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.event.check_run.head_sha }}"
          gh api repos/${{ github.repository }}/statuses/$SHA \
            -X POST \
            -f state=success \
            -f context=dco \
            -f description="DCO automatically overridden for bot commits"
          echo "DCO overridden for bot PR"

  # Handle build failures on Copilot PRs
  handle-build-failure:
    if: |
      github.event_name == 'check_run' &&
      github.event.check_run.conclusion == 'failure' &&
      github.event.check_run.name != 'dco'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=$(echo '${{ toJson(github.event.check_run.pull_requests) }}' | jq -r '.[0].number')
          if [ -z "$PR_NUM" ] || [ "$PR_NUM" == "null" ]; then
            echo "No PR found"
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM)
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.draft')

          echo "PR #$PR_NUM author: $PR_AUTHOR, draft: $IS_DRAFT"

          if [[ "$PR_AUTHOR" == *"copilot"* ]] || [[ "$PR_AUTHOR" == "Copilot" ]]; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_copilot=false" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR about build failure
        if: steps.pr_info.outputs.is_copilot == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_info.outputs.pr_number }}"
          CHECK_NAME="${{ github.event.check_run.name }}"
          CHECK_URL="${{ github.event.check_run.html_url }}"

          # Get the failure details
          DETAILS=$(gh api repos/${{ github.repository }}/check-runs/${{ github.event.check_run.id }} --jq '.output.summary // .output.text // "No details available"' | head -500)

          # Use heredoc for multiline comment to avoid YAML escaping issues
          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## ðŸ”´ Build Failure Detected

          **Check:** $CHECK_NAME
          **Status:** Failed
          **Details:** [View Check Run]($CHECK_URL)

          ### Error Summary
          $DETAILS

          ---
          @copilot-swe-agent Please investigate and fix this build failure. Once fixed, push your changes to this PR.

          *This comment was automatically generated by the Copilot Error Recovery workflow.*
          EOF
          )"
          echo "Posted failure comment on PR #$PR_NUM"

  # Handle successful builds - trigger preview testing
  handle-build-success:
    if: |
      github.event_name == 'check_run' &&
      github.event.check_run.conclusion == 'success' &&
      contains(github.event.check_run.name, 'netlify')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=$(echo '${{ toJson(github.event.check_run.pull_requests) }}' | jq -r '.[0].number')
          if [ -z "$PR_NUM" ] || [ "$PR_NUM" == "null" ]; then
            echo "No PR found"
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM)
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.draft')
          PR_BODY=$(echo "$PR_DATA" | jq -r '.body')

          # Extract linked issue number
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oP '(?:Fixes|Closes|Resolves)\s+(?:\S+)?#\K\d+' | head -1)

          echo "PR #$PR_NUM author: $PR_AUTHOR, draft: $IS_DRAFT, linked issue: $ISSUE_NUM"

          if [[ "$PR_AUTHOR" == *"copilot"* ]] || [[ "$PR_AUTHOR" == "Copilot" ]]; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_copilot=false" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Get Netlify preview URL
        if: steps.pr_info.outputs.is_copilot == 'true'
        id: preview
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_info.outputs.pr_number }}"

          # Get the Netlify deploy preview URL from check run
          PREVIEW_URL="${{ github.event.check_run.details_url }}"

          # Or construct it from the PR number
          if [ -z "$PREVIEW_URL" ]; then
            PREVIEW_URL="https://deploy-preview-${PR_NUM}--kubestellarklaudeconsole.netlify.app"
          fi

          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "Preview URL: $PREVIEW_URL"

      - name: Request Copilot to test preview
        if: steps.pr_info.outputs.is_copilot == 'true' && steps.pr_info.outputs.is_draft == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_info.outputs.pr_number }}"
          ISSUE_NUM="${{ steps.pr_info.outputs.issue_number }}"
          PREVIEW_URL="${{ steps.preview.outputs.preview_url }}"

          # Get the issue body for test context
          ISSUE_BODY=""
          if [ -n "$ISSUE_NUM" ]; then
            ISSUE_BODY=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUM --jq '.body' | head -1000)
          fi

          # Use heredoc for multiline comment to avoid YAML escaping issues
          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## âœ… Build Successful - Preview Ready

          **Netlify Preview:** $PREVIEW_URL

          ### CRITICAL: Runtime Testing Required

          @copilot-swe-agent The build has passed. You MUST now verify the preview actually works.

          #### Step 1: Runtime Verification (BLOCKING)
          Navigate to: $PREVIEW_URL

          **Check for these CRITICAL issues:**
          - [ ] Page renders (NOT blank/black screen)
          - [ ] No JavaScript console errors
          - [ ] App is interactive (buttons, navigation work)

          **If ANY of these fail:**
          1. Report the exact error in a comment
          2. Investigate and fix the root cause
          3. Push the fix and wait for new preview
          4. Re-test from Step 1

          #### Step 2: Feature Testing
          Based on the original issue requirements:
          - [ ] All requested features are implemented
          - [ ] Visual/UI correctness verified
          - [ ] No console warnings or errors
          - [ ] Responsive behavior (if applicable)

          #### Step 3: Report Results
          Post a comment with:
          - Screenshot or description of what you tested
          - List of any issues found and how you fixed them
          - Confirmation that all tests pass

          #### Step 4: Mark Ready for Review
          Only after ALL tests pass, mark PR as ready for review.

          ### Original Issue Requirements
          $ISSUE_BODY

          ---
          **CRITICAL:** A passing build does NOT mean the app works. Runtime errors like blank pages, console errors, or broken functionality MUST be detected and fixed.

          If you cannot access the preview URL, report that issue immediately.

          *This comment was automatically generated by the Copilot Error Recovery workflow.*
          EOF
          )"
          echo "Posted test request on PR #$PR_NUM"

  # Handle workflow run completion (for more complex build pipelines)
  handle-workflow-completion:
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    steps:
      - name: Check workflow result
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"

          echo "Workflow '${{ github.event.workflow_run.name }}' completed with: $CONCLUSION"

          # Find PR for this commit
          PR_DATA=$(gh api repos/${{ github.repository }}/commits/$HEAD_SHA/pulls --jq '.[0]' 2>/dev/null || echo "")

          if [ -z "$PR_DATA" ] || [ "$PR_DATA" == "null" ]; then
            echo "No PR found for commit $HEAD_SHA"
            exit 0
          fi

          PR_NUM=$(echo "$PR_DATA" | jq -r '.number')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')

          echo "PR #$PR_NUM by $PR_AUTHOR"

          if [[ "$PR_AUTHOR" != *"copilot"* ]] && [[ "$PR_AUTHOR" != "Copilot" ]]; then
            echo "Not a Copilot PR, skipping"
            exit 0
          fi

          if [ "$CONCLUSION" == "failure" ]; then
            # Get workflow run logs URL
            RUN_URL="${{ github.event.workflow_run.html_url }}"
            WF_NAME="${{ github.event.workflow_run.name }}"

            # Use heredoc for multiline comment
            gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
            ## ðŸ”´ Workflow Failed

            **Workflow:** $WF_NAME
            **Status:** Failed
            **Details:** [View Workflow Run]($RUN_URL)

            @copilot-swe-agent Please investigate the workflow failure and push fixes.

            *This comment was automatically generated.*
            EOF
            )"
          fi

  # Handle code review feedback on Copilot PRs
  handle-review-feedback:
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested') ||
      github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is from Copilot
        id: check_copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_AUTHOR=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM --jq '.user.login')

          if [[ "$PR_AUTHOR" == *"copilot"* ]] || [[ "$PR_AUTHOR" == "Copilot" ]]; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          else
            echo "is_copilot=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Copilot of review feedback
        if: steps.check_copilot.outputs.is_copilot == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.check_copilot.outputs.pr_number }}"
          REVIEWER="${{ github.event.review.user.login || github.event.comment.user.login }}"

          # Get the review/comment body
          if [ "${{ github.event_name }}" == "pull_request_review" ]; then
            FEEDBACK="${{ github.event.review.body }}"
            FEEDBACK_TYPE="review"
          else
            FEEDBACK="${{ github.event.comment.body }}"
            FEEDBACK_TYPE="comment"
          fi

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(cat <<EOF
          ## ðŸ“ Code Review Feedback Received

          **Reviewer:** @$REVIEWER
          **Type:** $FEEDBACK_TYPE

          @copilot-swe-agent A reviewer has provided feedback on your PR. Please:

          1. **Read and understand** the feedback above
          2. **Address all requested changes**
          3. **Push commits** with the fixes
          4. **Reply** to confirm the changes have been made

          If you disagree with any feedback, explain your reasoning in a reply.

          ---
          *This notification was automatically generated.*
          EOF
          )"
