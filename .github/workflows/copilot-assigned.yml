name: Copilot Assigned
# Path B: Triggers when someone manually assigns Copilot to an issue via GitHub UI.
# Adds labels so the rest of the pipeline (ai-fix.yml label tracking, copilot-recovery.yml)
# works correctly without additional manual steps.

on:
  issues:
    types: [assigned]

permissions:
  contents: read
  issues: write

jobs:
  handle-copilot-assignment:
    if: |
      github.event.assignee.login == 'Copilot' ||
      github.event.assignee.login == 'copilot-swe-agent'
    runs-on: ubuntu-latest

    steps:
      - name: Check if already processing
        id: check_state
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ github.event.issue.number }}"
          LABELS=$(gh api repos/${{ github.repository }}/issues/$ISSUE \
            --jq '[.labels[].name] | join(",")' 2>/dev/null || echo "")

          if echo "$LABELS" | grep -q "ai-processing\|ai-awaiting-fix\|ai-pr-draft\|ai-pr-ready"; then
            echo "already_processing=true" >> $GITHUB_OUTPUT
            echo "Issue #$ISSUE already in pipeline (labels: $LABELS)"
          else
            echo "already_processing=false" >> $GITHUB_OUTPUT
          fi

      - name: Add triage and AI labels
        if: steps.check_state.outputs.already_processing == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ github.event.issue.number }}"

          # Create labels if they don't exist
          gh label create "triage/accepted" --repo "$REPO" --color "0e8a16" \
            --description "Issue has been triaged and accepted" 2>/dev/null || true
          gh label create "ai-fix-requested" --repo "$REPO" --color "d4c5f9" \
            --description "AI fix has been requested" 2>/dev/null || true
          gh label create "ai-processing" --repo "$REPO" --color "fbca04" \
            --description "AI is currently processing this issue" 2>/dev/null || true
          gh label create "ai-awaiting-fix" --repo "$REPO" --color "6f42c1" \
            --description "Copilot is working on a fix" 2>/dev/null || true

          # Add labels
          gh issue edit "$ISSUE" --repo "$REPO" \
            --add-label "triage/accepted" \
            --add-label "ai-fix-requested" \
            --add-label "ai-awaiting-fix"

          echo "Labels applied to issue #$ISSUE"

      - name: Add rocket reaction
        if: steps.check_state.outputs.already_processing == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -X POST -f content='rocket'

      - name: Post acknowledgment comment
        if: steps.check_state.outputs.already_processing == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ github.event.issue.number }}"

          gh issue comment "$ISSUE" --repo "${{ github.repository }}" --body "$(cat <<'EOF'
          ## ðŸ¤– Copilot Assigned

          Copilot has been assigned to this issue and will:
          1. Analyze the issue description
          2. Explore the codebase for context
          3. Implement a fix and create a PR
          4. Run build/lint verification via `copilot-setup-steps.yml`
          5. Test the Netlify preview deployment

          Labels have been automatically updated. The pipeline will track progress through to completion.
          EOF
          )"
