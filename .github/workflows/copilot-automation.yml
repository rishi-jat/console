name: Copilot PR Automation

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to process
        required: true
        type: string
  pull_request_target:
    types: [opened, synchronize, ready_for_review]
  check_run:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write

concurrency:
  group: copilot-automation-${{ github.event.pull_request.number || github.event.check_run.pull_requests[0].number || github.event.inputs.pr_number || github.sha }}
  cancel-in-progress: true

jobs:
  copilot-automation:
    runs-on: ubuntu-latest
    steps:
      - name: Process Copilot PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CONSOLE_AUTO || secrets.GITHUB_TOKEN }}
          script: |
            // Get PR info based on event type
            let prNumber, pr;

            let isCheckRunFailure = false;
            let checkRunUrl = '';

            if (context.eventName === 'workflow_dispatch') {
              prNumber = parseInt(context.payload.inputs.pr_number, 10);
            } else if (context.eventName === 'pull_request_target') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'check_run') {
              const checkRun = context.payload.check_run;
              const prs = checkRun.pull_requests;
              if (!prs || prs.length === 0) {
                core.info('No PRs for this check run');
                return;
              }
              prNumber = prs[0].number;
              // Check if this is a Netlify failure
              if (checkRun.name && checkRun.name.toLowerCase().includes('netlify') &&
                  checkRun.conclusion === 'failure') {
                isCheckRunFailure = true;
                checkRunUrl = checkRun.details_url || '';
              }
            }

            if (!prNumber) {
              core.info('No PR number found');
              return;
            }

            // Get PR details
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            pr = prData;

            // Check if Copilot PR
            const author = pr.user.login;
            const isCopilot = author === 'Copilot' ||
                              author.toLowerCase().includes('copilot') ||
                              author.includes('[bot]');

            if (!isCopilot) {
              core.info(`PR #${prNumber} author ${author} is not Copilot, skipping`);
              return;
            }

            core.info(`Processing Copilot PR #${prNumber}`);
            const headSha = pr.head.sha;

            // 1. Override DCO
            core.info('Setting DCO status to success...');
            try {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: headSha,
                state: 'success',
                context: 'dco',
                description: 'DCO waived for Copilot',
                target_url: 'https://github.com/kubestellar/console/blob/master/CONTRIBUTING.md'
              });
              core.info('DCO status set to success');
            } catch (e) {
              core.warning(`Failed to set DCO: ${e.message}`);
            }

            // 2. Fix DCO labels
            core.info('Fixing DCO labels...');
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'dco-signoff: no'
              });
            } catch (e) { /* ignore */ }

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['dco-signoff: yes']
              });
            } catch (e) {
              core.warning(`Failed to add label: ${e.message}`);
            }

            // 3. Fix title â€” strip WIP and ensure emoji prefix (required by Prow)
            let title = pr.title;
            let needsUpdate = false;
            let newTitle = title;

            // Strip [WIP] prefix
            if (newTitle.includes('[WIP]')) {
              core.info('Stripping WIP from title...');
              newTitle = newTitle.replace('[WIP] ', '').replace('[WIP]', '').trim();
              needsUpdate = true;

              // Remove WIP label
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: 'do-not-merge/work-in-progress'
                });
              } catch (e) { /* ignore */ }
            }

            // Ensure emoji prefix (Prow requires it)
            // Check if title already starts with an emoji (non-ASCII, non-word char)
            const hasEmoji = /^[^\w\s\[]/.test(newTitle) || /^[\u{1F000}-\u{1FFFF}]/u.test(newTitle);
            if (!hasEmoji) {
              core.info('Adding emoji prefix to title...');
              // Pick emoji based on linked issue labels or title keywords
              const labels = pr.labels ? pr.labels.map(l => l.name) : [];
              const lowerTitle = newTitle.toLowerCase();
              let emoji = '\uD83D\uDC1B'; // ðŸ› default (bug fix)
              if (labels.includes('enhancement') || lowerTitle.includes('add') || lowerTitle.includes('feature') || lowerTitle.includes('implement')) {
                emoji = '\u2728'; // âœ¨ feature
              } else if (lowerTitle.includes('refactor') || lowerTitle.includes('split') || lowerTitle.includes('replace') || lowerTitle.includes('reduce')) {
                emoji = '\uD83C\uDF31'; // ðŸŒ± improvement
              } else if (lowerTitle.includes('doc') || lowerTitle.includes('readme')) {
                emoji = '\uD83D\uDCD6'; // ðŸ“– docs
              }
              newTitle = `${emoji} ${newTitle}`;
              needsUpdate = true;
            }

            if (needsUpdate) {
              try {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  title: newTitle
                });
                core.info(`Title updated to: ${newTitle}`);
              } catch (e) {
                core.warning(`Failed to update title: ${e.message}`);
              }
            }

            // 4. Mark ready for review if draft AND checks have passed
            if (pr.draft) {
              // Only auto-mark ready on check_run or status events (not on PR open)
              const shouldCheckReady = context.eventName === 'check_run' ||
                                       context.eventName === 'workflow_dispatch';
              if (shouldCheckReady) {
                // Check if Netlify deploy preview passed
                const { data: checkRuns } = await github.rest.checks.listForRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: headSha
                });
                const netlifyCheck = checkRuns.check_runs.find(c =>
                  c.name && c.name.toLowerCase().includes('netlify') &&
                  c.name.toLowerCase().includes('deploy-preview')
                );
                const netlifyPassed = netlifyCheck &&
                  netlifyCheck.status === 'completed' &&
                  netlifyCheck.conclusion === 'success';

                if (netlifyPassed) {
                  core.info('Netlify passed, marking PR as ready for review...');
                  try {
                    await github.graphql(`
                      mutation($prId: ID!) {
                        markPullRequestReadyForReview(input: {pullRequestId: $prId}) {
                          pullRequest { id }
                        }
                      }
                    `, { prId: pr.node_id });
                    core.info('Marked as ready for review');
                  } catch (e) {
                    core.warning(`Failed to mark ready: ${e.message}`);
                  }
                } else {
                  core.info('Netlify check not yet passed, skipping ready marking');
                }
              } else {
                core.info('Skipping ready check on PR open/sync â€” waiting for checks to pass');
              }
            }

            // 5. Handle build failures - notify Copilot
            if (isCheckRunFailure) {
              core.info('Netlify build failed, checking for recent notifications...');

              // Check if we already notified recently
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                per_page: 10
              });

              const recentBuildNotification = comments.find(c =>
                c.body.includes('Build Failed') &&
                c.body.includes('@Copilot') &&
                new Date(c.created_at) > new Date(Date.now() - 30 * 60 * 1000)
              );

              if (!recentBuildNotification) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `## Build Failed\n\n@Copilot The Netlify build has failed. Please check the build logs and fix the error.\n\n**Build URL:** ${checkRunUrl}\n\nCommon issues:\n- Missing imports or undefined functions\n- TypeScript type errors\n- Unused variables\n\nPlease analyze the error and push a fix.`
                });
                core.info('Posted build failure notification');
              } else {
                core.info('Recent build failure notification exists, skipping');
              }
            }

            core.info('Copilot PR automation complete');
