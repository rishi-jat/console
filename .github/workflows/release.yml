name: Release

on:
  schedule:
    # Nightly at 5 AM UTC (midnight Eastern during EST, 1 AM during EDT)
    - cron: '0 5 * * *'
    # Weekly on Sunday at 5 AM UTC
    - cron: '0 5 * * 0'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'nightly'
        type: choice
        options:
          - nightly
          - weekly
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        default: false
        type: boolean
      force_agent_release:
        description: 'Force agent/Homebrew release even without changes'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_type: ${{ steps.type.outputs.release_type }}
      is_prerelease: ${{ steps.type.outputs.is_prerelease }}
      agent_changed: ${{ steps.changes.outputs.agent_changed }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Determine release type
        id: type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          elif [ "${{ github.event.schedule }}" = "0 5 * * 0" ]; then
            RELEASE_TYPE="weekly"
          else
            RELEASE_TYPE="nightly"
          fi

          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT

          if [ "$RELEASE_TYPE" = "nightly" ] || [ "$RELEASE_TYPE" = "weekly" ]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "Release type: $RELEASE_TYPE"

      - name: Get latest tag
        id: latest_tag
        run: |
          # Get latest version tag (including pre-releases for change detection)
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -n1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

          # Get latest stable version tag (for version calculation)
          LATEST_STABLE=$(git tag -l 'v*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
          if [ -z "$LATEST_STABLE" ]; then
            LATEST_STABLE="v0.0.0"
          fi
          echo "latest_stable=$LATEST_STABLE" >> $GITHUB_OUTPUT
          echo "Latest stable tag: $LATEST_STABLE"

      - name: Check for changes since last release
        id: changes
        run: |
          LATEST_TAG="${{ steps.latest_tag.outputs.latest_tag }}"
          FORCE_AGENT="${{ github.event.inputs.force_agent_release }}"
          RELEASE_TYPE="${{ steps.type.outputs.release_type }}"

          # For stable releases (patch/minor/major), always include agent
          if [ "$RELEASE_TYPE" != "nightly" ] && [ "$RELEASE_TYPE" != "weekly" ]; then
            echo "Stable release - including agent"
            echo "agent_changed=true" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if forced
          if [ "$FORCE_AGENT" = "true" ]; then
            echo "Force agent release requested"
            echo "agent_changed=true" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for any changes since last tag
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            echo "No previous tag - including everything"
            echo "agent_changed=true" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for changes in agent-related paths
          AGENT_PATHS="pkg/agent cmd/kkc-agent go.mod go.sum"
          AGENT_CHANGED="false"

          for path in $AGENT_PATHS; do
            if git diff --name-only "$LATEST_TAG"..HEAD | grep -q "^$path"; then
              echo "Agent changes detected in: $path"
              AGENT_CHANGED="true"
              break
            fi
          done

          echo "agent_changed=$AGENT_CHANGED" >> $GITHUB_OUTPUT

          # Check for any changes at all
          TOTAL_CHANGES=$(git rev-list "$LATEST_TAG"..HEAD --count)
          if [ "$TOTAL_CHANGES" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Total commits since last release: $TOTAL_CHANGES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes since last release"
          fi

          echo "Agent changed: $AGENT_CHANGED"

      - name: Calculate new version
        id: version
        run: |
          LATEST="${{ steps.latest_tag.outputs.latest_stable }}"
          RELEASE_TYPE="${{ steps.type.outputs.release_type }}"
          DATE=$(date +%Y%m%d)

          # Remove 'v' prefix
          VERSION=${LATEST#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          case $RELEASE_TYPE in
            nightly)
              NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))-nightly.${DATE}"
              ;;
            weekly)
              NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))-weekly.${DATE}"
              ;;
            patch)
              NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
            minor)
              NEW_VERSION="v${MAJOR}.$((MINOR + 1)).0"
              ;;
            major)
              NEW_VERSION="v$((MAJOR + 1)).0.0"
              ;;
          esac

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

  test:
    runs-on: ubuntu-latest
    needs: determine-version
    if: needs.determine-version.outputs.has_changes == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version: '1.23'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Run Go tests
        run: go test -v ./...

      - name: Install frontend dependencies
        working-directory: web
        run: npm ci

      - name: Build frontend
        working-directory: web
        run: npm run build

      - name: Lint frontend
        working-directory: web
        run: npm run lint || true

  release:
    needs: [determine-version, test]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.dry_run != 'true' && needs.determine-version.outputs.has_changes == 'true' }}
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        if: needs.determine-version.outputs.agent_changed == 'true'
        with:
          go-version: '1.23'
          cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if tag exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, force updating..."
            git tag -d "$VERSION"
            git push origin ":refs/tags/$VERSION" || true
          fi

          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: Run GoReleaser (agent + Homebrew)
        if: needs.determine-version.outputs.agent_changed == 'true'
        uses: goreleaser/goreleaser-action@9c156ee8a17a598857849441385a2041ef570552 # v6.3.0
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Create GitHub release (no agent)
        if: needs.determine-version.outputs.agent_changed != 'true'
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          tag_name: ${{ needs.determine-version.outputs.version }}
          name: ${{ needs.determine-version.outputs.version }}
          prerelease: ${{ needs.determine-version.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          body: |
            ## Changes

            This release contains web/console updates only. No changes to kkc-agent binary.

            The Homebrew formula was not updated as there are no agent changes.

      - name: Build and push Docker image
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6.16.0
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-version.outputs.release_type }}
          build-args: |
            COMMIT_HASH=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  notify:
    needs: [determine-version, release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.determine-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ needs.determine-version.outputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: ${{ needs.determine-version.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Agent changed**: ${{ needs.determine-version.outputs.agent_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has changes**: ${{ needs.determine-version.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.determine-version.outputs.has_changes }}" != "true" ]; then
            echo "### Skipped" >> $GITHUB_STEP_SUMMARY
            echo "No changes since last release. Release was skipped." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.release.result }}" = "success" ]; then
            echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.determine-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- Docker Image: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.determine-version.outputs.agent_changed }}" = "true" ]; then
              echo "- Homebrew: \`brew upgrade kkc-agent\` (formula updated)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Homebrew: No update (no agent changes)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Status: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          fi
