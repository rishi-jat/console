name: Auto-Apply Copilot Review Suggestions
# When Copilot code review agent posts suggestions on a PR,
# automatically tell the coding agent to apply them.
# Works for both Copilot-authored and human-authored PRs.

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  apply-copilot-review:
    # Only trigger when Copilot review agent submits a non-approval review
    if: |
      contains(fromJSON('["github-copilot[bot]", "copilot"]'), github.event.review.user.login) &&
      github.event.review.state != 'approved'
    runs-on: ubuntu-latest
    steps:
      - name: Apply Copilot review suggestions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CONSOLE_AUTO || secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const reviewId = context.payload.review.id;
            const reviewState = context.payload.review.state;
            const prAuthor = context.payload.pull_request.user.login;

            core.info(`Copilot review on PR #${prNumber} (state: ${reviewState}, author: ${prAuthor})`);

            // Get all review comments for this review
            const { data: allComments } = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              per_page: 100,
            });

            // Filter to comments from this review
            const reviewComments = allComments.filter(c =>
              c.pull_request_review_id === reviewId
            );

            if (reviewComments.length === 0) {
              core.info('No review comments found, skipping');
              return;
            }

            // Categorize comments
            const suggestions = [];
            const generalComments = [];

            for (const comment of reviewComments) {
              if (comment.body && comment.body.includes('```suggestion')) {
                suggestions.push(comment);
              } else {
                generalComments.push(comment);
              }
            }

            core.info(`Found ${suggestions.length} suggestions, ${generalComments.length} general comments`);

            // Build instruction comment for Copilot coding agent
            let body = `## ðŸ”„ Auto-Applying Copilot Code Review\n\n`;
            body += `Copilot code review found **${suggestions.length} code suggestion(s)** and **${generalComments.length} general comment(s)**.\n\n`;

            if (suggestions.length > 0) {
              body += `@copilot Please apply **all** of the following code review suggestions:\n\n`;

              for (const s of suggestions) {
                const line = s.line || s.original_line || '?';
                // Extract the suggestion text for clarity
                const match = s.body.match(/```suggestion\n([\s\S]*?)```/);
                const preview = match ? match[1].trim().substring(0, 80) : '(see suggestion above)';
                body += `- **\`${s.path}\`** (line ${line}): \`${preview}${preview.length >= 80 ? '...' : ''}\`\n`;
              }

              body += `\n`;
            }

            if (generalComments.length > 0) {
              body += `Also address these general comments:\n\n`;

              for (const c of generalComments) {
                const line = c.line || c.original_line || '?';
                const preview = (c.body || '').substring(0, 120).replace(/\n/g, ' ');
                body += `- **\`${c.path}\`** (line ${line}): ${preview}\n`;
              }

              body += `\n`;
            }

            body += `Push all fixes in a single commit. Run \`cd web && npm run build && npm run lint\` before committing.\n\n`;
            body += `---\n*Auto-generated by copilot-review-apply workflow.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body,
            });

            core.info(`Posted review application request on PR #${prNumber}`);

            // For non-Copilot PRs, also try to assign Copilot coding agent
            const isCopilotPR = prAuthor === 'copilot-swe-agent[bot]' ||
                                prAuthor.toLowerCase().includes('copilot') ||
                                prAuthor.includes('[bot]');

            if (!isCopilotPR) {
              core.info('Human PR â€” assigning Copilot coding agent to apply suggestions');
              const repo = `${context.repo.owner}/${context.repo.repo}`;
              try {
                await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  assignees: ['copilot-swe-agent[bot]'],
                  agent_assignment: {
                    target_repo: repo,
                    base_branch: context.payload.pull_request.head.ref,
                  },
                });
                core.info(`Assigned Copilot coding agent to PR #${prNumber}`);
              } catch (e) {
                core.warning(`Could not assign Copilot to PR #${prNumber}: ${e.message}`);
                core.info('The @copilot mention in the comment should still trigger the agent.');
              }
            }
